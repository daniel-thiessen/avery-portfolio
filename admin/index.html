<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <style>
    /* Custom styles for debugging panel */
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f3f3f3;
      border-top: 1px solid #ddd;
      padding: 10px 20px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
      max-height: 30vh;
      overflow-y: auto;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    #debug-panel.collapsed {
      transform: translateY(calc(100% - 30px));
    }
    
    #debug-panel h3 {
      margin: 0;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }
    
    #debug-content {
      margin-top: 10px;
    }
    
    #debug-log {
      max-height: 150px;
      overflow-y: auto;
      background: #fff;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    
    #debug-log p {
      margin: 5px 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    
    #debug-log p:last-child {
      border-bottom: none;
    }
    
    .btn {
      background: #2d2d2d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
    }
    
    .btn:hover {
      background: #444;
    }
  </style>
  <!-- Debug logging for Netlify CMS -->
  <script>
    window.CMS_MANUAL_INIT = true; // Prevent auto initialization
  </script>
</head>
<body>
  <!-- Add login status indicator -->
  <div id="login-status" style="padding: 20px; color: #666; display: none;">
    Checking authentication status...
  </div>
  
  <!-- Debug panel for authentication and content loading -->
  <div id="debug-panel" class="collapsed">
    <h3 id="debug-header">
      <span>Debug Panel (click to toggle)</span>
      <span id="debug-indicator">‚óè</span>
    </h3>
    <div id="debug-content">
      <div id="debug-buttons">
        <button class="btn" id="test-auth">Test Auth</button>
        <button class="btn" id="clear-cache">Clear Cache</button>
        <button class="btn" id="reload-cms">Reload CMS</button>
        <button class="btn" id="clear-log">Clear Log</button>
      </div>
      <div id="debug-log"></div>
    </div>
  </div>
  
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Debug panel functionality
    (function setupDebugPanel() {
      const debugPanel = document.getElementById('debug-panel');
      const debugHeader = document.getElementById('debug-header');
      const debugLog = document.getElementById('debug-log');
      const testAuthBtn = document.getElementById('test-auth');
      const clearCacheBtn = document.getElementById('clear-cache');
      const reloadCmsBtn = document.getElementById('reload-cms');
      const clearLogBtn = document.getElementById('clear-log');
      const debugIndicator = document.getElementById('debug-indicator');
      
      // Toggle debug panel
      debugHeader.addEventListener('click', () => {
        debugPanel.classList.toggle('collapsed');
      });
      
      // Add log entry
      window.addDebugLog = function(message, type = 'info') {
        const entry = document.createElement('p');
        entry.textContent = `${new Date().toLocaleTimeString()} [${type}] ${message}`;
        entry.className = type;
        debugLog.appendChild(entry);
        debugLog.scrollTop = debugLog.scrollHeight;
        
        // Update indicator
        if (type === 'error') {
          debugIndicator.style.color = 'red';
        } else if (type === 'success') {
          debugIndicator.style.color = 'green';
        } else {
          debugIndicator.style.color = 'blue';
        }
      };
      
      // Test authentication
      testAuthBtn.addEventListener('click', async () => {
        try {
          window.addDebugLog('Testing GitHub API authentication...');
          const response = await fetch('https://api.github.com/repos/daniel-thiessen/avery-portfolio/contents/_data/settings.yml');
          const status = response.status;
          window.addDebugLog(`API response status: ${status}`, status === 200 ? 'success' : 'error');
          
          if (status === 200) {
            const data = await response.json();
            window.addDebugLog(`Successfully retrieved file info: ${data.name}, size: ${data.size} bytes`, 'success');
          }
        } catch (err) {
          window.addDebugLog(`Authentication test failed: ${err.message}`, 'error');
        }
      });
      
      // Clear cache
      clearCacheBtn.addEventListener('click', () => {
        window.addDebugLog('Clearing local storage and cache...');
        try {
          localStorage.clear();
          sessionStorage.clear();
          
          // Clear application cache if supported
          if (window.caches) {
            caches.keys().then(names => {
              names.forEach(name => {
                caches.delete(name);
              });
            });
          }
          
          window.addDebugLog('Cache cleared successfully', 'success');
        } catch (err) {
          window.addDebugLog(`Failed to clear cache: ${err.message}`, 'error');
        }
      });
      
      // Reload CMS
      reloadCmsBtn.addEventListener('click', () => {
        window.addDebugLog('Reloading CMS...');
        window.location.reload();
      });
      
      // Clear log
      clearLogBtn.addEventListener('click', () => {
        debugLog.innerHTML = '';
        window.addDebugLog('Log cleared');
      });
      
      // Initial log entry
      window.addDebugLog('Debug panel initialized');
      window.addDebugLog(`User agent: ${navigator.userAgent}`);
    })();
    
    // Initialize CMS with enhanced debugging
    (function initCMS() {
      const statusDiv = document.getElementById('login-status');
      statusDiv.style.display = 'block';
      
      if (window.netlifyIdentity) {
        statusDiv.innerText = 'Netlify Identity is enabled';
        window.addDebugLog('Netlify Identity detected');
      }
      
      // Log CMS lifecycle events
      window.CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          const entryData = entry.get('data').toJS();
          console.log('About to save entry:', entryData);
          window.addDebugLog(`Saving: ${entryData.title || entry.get('slug')}`);
          statusDiv.innerText = 'Saving content...';
          return entry;
        },
      });

      window.CMS.registerEventListener({
        name: 'postSave',
        handler: ({ entry }) => {
          const entryData = entry.get('data').toJS();
          console.log('Entry was saved:', entryData);
          window.addDebugLog(`Saved: ${entryData.title || entry.get('slug')}`, 'success');
          statusDiv.innerText = 'Content saved successfully!';
        },
      });
      
      // Auth success/failure events
      window.CMS.registerEventListener({
        name: 'login', 
        handler: () => {
          console.log('User logged in');
          window.addDebugLog('User authenticated successfully', 'success');
          statusDiv.innerText = 'Authenticated with GitHub';
        }
      });
      
      window.CMS.registerEventListener({
        name: 'auth',
        handler: (auth) => {
          console.log('Auth status update:', auth);
          window.addDebugLog(`Auth status updated: ${auth ? 'authenticated' : 'not authenticated'}`);
        }
      });
      
      window.CMS.registerEventListener({
        name: 'error',
        handler: (err) => {
          console.error('CMS error:', err);
          window.addDebugLog(`Error: ${err.message || 'Unknown error'}`, 'error');
        }
      });

      // Initialize CMS with full config
      try {
        window.addDebugLog('Initializing CMS with explicit config');
        
        CMS.init({
          config: {
            backend: {
              name: 'github',
              repo: 'daniel-thiessen/avery-portfolio',
              branch: 'main',
              base_url: 'https://github.com',
              auth_endpoint: '/login/oauth/authorize',
              api_root: 'https://api.github.com',
              app_id: '',  // Leave blank for direct GitHub OAuth
              auth_type: 'implicit',  // Use implicit flow for direct GitHub auth
              commit_messages: {
                create: 'Create {{collection}} "{{slug}}"',
                update: 'Update {{collection}} "{{slug}}"',
                delete: 'Delete {{collection}} "{{slug}}"',
                uploadMedia: 'Upload "{{path}}"',
                deleteMedia: '[skip ci] Delete "{{path}}"'
              }
            },
            load_config_file: true, // Load config from config.yml
            media_folder: "images",
            public_folder: "/images",
            publish_mode: "editorial_workflow",
            show_preview_links: true,
            local_backend: false
          }
        });
        
        window.addDebugLog('CMS initialized successfully');
      } catch (err) {
        console.error('CMS initialization error:', err);
        window.addDebugLog(`CMS init error: ${err.message}`, 'error');
        statusDiv.innerText = `Error initializing CMS: ${err.message}`;
      }
    })();
  </script>
</body>
</html>